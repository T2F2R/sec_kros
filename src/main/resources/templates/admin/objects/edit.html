<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Редактировать объект охраны - Админ панель</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://api-maps.yandex.ru/2.1/?apikey=25bdb038-e6c4-4bbe-88cd-d18d451466a1&lang=ru_RU" type="text/javascript"></script>
  <style>
    #map {
      width: 100%;
      height: 400px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .coordinates-display {
      background-color: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="/admin/dashboard">SEC Admin</a>
    <div class="navbar-nav ms-auto">
      <a class="nav-link" href="/admin/objects">Назад к списку</a>
      <a class="nav-link" href="/logout">Выйти</a>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <div class="row">
    <div class="col-md-8 mx-auto">
      <h1>Редактировать объект охраны</h1>

      <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
      <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>

      <div class="card">
        <div class="card-body">
          <form th:action="@{/admin/objects/edit/{id}(id=${guardObjectDTO.id})}" th:object="${guardObjectDTO}" method="post" id="objectForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="clientId" class="form-label">Клиент *</label>
                <select class="form-select" id="clientId" th:field="*{clientId}" required>
                  <option value="">Выберите клиента</option>
                  <option th:each="client : ${clients}"
                          th:value="${client.id}"
                          th:selected="${client.id == guardObjectDTO.clientId}"
                          th:text="${client.lastName + ' ' + client.firstName + ' ' + (client.patronymic ?: '')}"></option>
                </select>
                <div th:if="${#fields.hasErrors('clientId')}" class="text-danger">
                  <small th:errors="*{clientId}"></small>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="contractId" class="form-label">Договор *</label>
                <select class="form-select" id="contractId" th:field="*{contractId}" required>
                  <option value="">Выберите договор</option>
                  <option th:each="contract : ${contracts}"
                          th:value="${contract.id}"
                          th:selected="${contract.id == guardObjectDTO.contractId}"
                          th:text="'Договор №' + ${contract.id} + ' - ' + ${contract.client.lastName}"></option>
                </select>
                <div th:if="${#fields.hasErrors('contractId')}" class="text-danger">
                  <small th:errors="*{contractId}"></small>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label for="name" class="form-label">Название объекта *</label>
              <input type="text" class="form-control" id="name" th:field="*{name}"
                     placeholder="Например: Офис компании, Склад, Жилой дом и т.д." required>
              <div th:if="${#fields.hasErrors('name')}" class="text-danger">
                <small th:errors="*{name}"></small>
              </div>
            </div>

            <div class="mb-3">
              <label for="address" class="form-label">Адрес *</label>
              <div class="input-group">
                <input type="text" class="form-control" id="address" th:field="*{address}"
                       placeholder="Введите адрес или выберите на карте" required>
                <button type="button" class="btn btn-outline-secondary" onclick="searchAddress()">
                  Найти на карте
                </button>
              </div>
              <div th:if="${#fields.hasErrors('address')}" class="text-danger">
                <small th:errors="*{address}"></small>
              </div>
            </div>

            <div class="coordinates-display">
              <div class="row">
                <div class="col-md-6">
                  <strong>Широта:</strong>
                  <span id="latitudeDisplay" th:if="${guardObjectDTO.latitude}"
                        th:text="${#numbers.formatDecimal(guardObjectDTO.latitude, 1, 6)}"></span>
                  <span id="latitudeDisplay" th:unless="${guardObjectDTO.latitude}">Не указана</span>
                  <input type="hidden" id="latitude" th:field="*{latitude}">
                </div>
                <div class="col-md-6">
                  <strong>Долгота:</strong>
                  <span id="longitudeDisplay" th:if="${guardObjectDTO.longitude}"
                        th:text="${#numbers.formatDecimal(guardObjectDTO.longitude, 1, 6)}"></span>
                  <span id="longitudeDisplay" th:unless="${guardObjectDTO.longitude}">Не указана</span>
                  <input type="hidden" id="longitude" th:field="*{longitude}">
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Выберите местоположение на карте:</label>
              <div id="map"></div>
              <div class="form-text">Кликните на карте, чтобы установить метку местоположения</div>
            </div>

            <div class="mb-3">
              <label for="description" class="form-label">Описание объекта</label>
              <textarea class="form-control" id="description" th:field="*{description}"
                        rows="3" placeholder="Дополнительная информация об объекте..."></textarea>
              <div th:if="${#fields.hasErrors('description')}" class="text-danger">
                <small th:errors="*{description}"></small>
              </div>
            </div>

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary">Сохранить изменения</button>
              <a href="/admin/objects" class="btn btn-secondary">Отмена</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  let map;
  let placemark;
  const initialLatitude = [[${guardObjectDTO.latitude}]];
  const initialLongitude = [[${guardObjectDTO.longitude}]];
  const initialAddress = [[${guardObjectDTO.address}]];

  // Инициализация карты
  ymaps.ready(init);

  function init() {
    console.log('YMaps ready, initializing map...');

    try {
      let center = [55.76, 37.64]; // Москва по умолчанию
      let zoom = 10;

      // Если есть начальные координаты, используем их
      if (initialLatitude && initialLongitude) {
        center = [initialLatitude.doubleValue(), initialLongitude.doubleValue()];
        zoom = 15;
        console.log('Используем начальные координаты:', center);
      }

      // Создаем карту
      map = new ymaps.Map("map", {
        center: center,
        zoom: zoom
      });

      console.log('Карта создана успешно');

      // Если есть начальные координаты, создаем метку
      if (initialLatitude && initialLongitude) {
        const coords = [initialLatitude.doubleValue(), initialLongitude.doubleValue()];
        placemark = new ymaps.Placemark(coords, {
          balloonContent: initialAddress || 'Объект охраны'
        }, {
          preset: 'islands#icon',
          iconColor: '#0095b6'
        });

        map.geoObjects.add(placemark);
        console.log('Метка создана на начальных координатах');
      }

      // Обработчик клика по карте
      map.events.add('click', function (e) {
        const coords = e.get('coords');
        console.log('Клик по карте:', coords);
        setCoordinates(coords);

        // Получаем адрес по координатам
        getAddressByCoords(coords);
      });

    } catch (error) {
      console.error('Ошибка при создании карты:', error);
      document.getElementById('map-container').innerHTML =
        '<div class="alert alert-warning">Карта временно недоступна. Вы можете ввести адрес вручную.</div>';
    }
  }

  // Установка координат
  function setCoordinates(coords) {
    // Устанавливаем координаты в скрытые поля
    document.getElementById('latitude').value = coords[0].toFixed(8);
    document.getElementById('longitude').value = coords[1].toFixed(8);

    // Обновляем отображение координат
    document.getElementById('latitudeDisplay').textContent = coords[0].toFixed(6);
    document.getElementById('longitudeDisplay').textContent = coords[1].toFixed(6);

    // Удаляем старую метку, если есть
    if (placemark) {
      map.geoObjects.remove(placemark);
    }

    // Создаем новую метку
    placemark = new ymaps.Placemark(coords, {
      balloonContent: 'Выбранное местоположение'
    }, {
      preset: 'islands#icon',
      iconColor: '#0095b6'
    });

    map.geoObjects.add(placemark);
    map.setCenter(coords, 15);
  }

  // Получение адреса по координатам
  function getAddressByCoords(coords) {
    ymaps.geocode(coords).then(function (res) {
      const firstGeoObject = res.geoObjects.get(0);
      if (firstGeoObject) {
        const address = firstGeoObject.getAddressLine();
        document.getElementById('address').value = address;
        console.log('Получен адрес:', address);
      }
    }).catch(function (error) {
      console.error('Ошибка при получении адреса:', error);
    });
  }

  // Поиск адреса
  function searchAddress() {
    const address = document.getElementById('address').value.trim();
    if (!address) {
      alert('Пожалуйста, введите адрес для поиска');
      return;
    }

    console.log('Поиск адреса:', address);

    if (!ymaps.geocode) {
      alert('Функция поиска адреса недоступна. Проверьте подключение Яндекс Карт.');
      return;
    }

    ymaps.geocode(address).then(function (res) {
      const firstGeoObject = res.geoObjects.get(0);
      if (!firstGeoObject) {
        alert('Адрес не найден. Попробуйте уточнить запрос.');
        return;
      }

      const coords = firstGeoObject.geometry.getCoordinates();
      console.log('Найденные координаты:', coords);

      setCoordinates(coords);

      // Обновляем адрес точным значением от Яндекс
      const exactAddress = firstGeoObject.getAddressLine();
      document.getElementById('address').value = exactAddress;

    }).catch(function (error) {
      console.error('Ошибка при поиске адреса:', error);
      alert('Произошла ошибка при поиске адреса: ' + error.message);
    });
  }

  // Валидация формы
  document.getElementById('objectForm').addEventListener('submit', function(e) {
    const latitude = document.getElementById('latitude').value;
    const longitude = document.getElementById('longitude').value;

    if (!latitude || !longitude) {
      e.preventDefault();
      alert('Пожалуйста, укажите местоположение объекта на карте');
      return false;
    }
  });

  // Назначаем обработчик кнопке после загрузки DOM
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM загружен, назначаем обработчики...');

    const searchBtn = document.getElementById('searchAddressBtn');
    if (searchBtn) {
      searchBtn.addEventListener('click', searchAddress);
      console.log('Обработчик кнопки назначен');
    } else {
      console.error('Кнопка searchAddressBtn не найдена!');
    }

    // Также обрабатываем нажатие Enter в поле адреса
    const addressInput = document.getElementById('address');
    if (addressInput) {
      addressInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          searchAddress();
        }
      });
    }
  });
</script>
</body>
</html>