<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Добавить объект охраны - Личный кабинет</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://api-maps.yandex.ru/2.1/?apikey=25bdb038-e6c4-4bbe-88cd-d18d451466a1&lang=ru_RU" type="text/javascript"></script>
  <style>
    #map {
      width: 100%;
      height: 400px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .coordinates-display {
      background-color: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    .alert-warning {
      background-color: #fff3cd;
      border-color: #ffeaa7;
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container">
    <a class="navbar-brand" href="/client/dashboard">
      <i class="fas fa-shield-alt"></i> SEC - Личный кабинет
    </a>
    <div class="navbar-nav ms-auto">
      <span class="navbar-text text-white me-3">
        <i class="fas fa-user"></i>
        <span th:text="${client.firstName + ' ' + client.lastName}">Иван Иванов</span>
      </span>
      <a class="nav-link text-white" href="/client/objects">Назад к списку</a>
      <a class="nav-link text-white" href="/logout">Выйти</a>
    </div>
  </div>
</nav>

<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-md-8 mx-auto">
      <h1>
        <i class="fas fa-plus"></i> Добавить объект охраны
      </h1>

      <!-- Информационное сообщение -->
      <div class="alert alert-warning">
        <h6 class="alert-heading">
          <i class="fas fa-info-circle"></i> Важная информация
        </h6>
        <p class="mb-0">
          Объекты охраны можно привязывать только к договорам, которые находятся на рассмотрении (статус "Неактивен").
          После одобрения договора администрацией вы сможете начать охрану объекта.
        </p>
      </div>

      <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
      <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>

      <div class="card">
        <div class="card-body">
          <form th:action="@{/client/objects/create}" th:object="${guardObjectDTO}" method="post" id="objectForm">
            <!-- Скрытое поле clientId -->
            <input type="hidden" th:field="*{clientId}" th:value="${client.id}">

            <div class="mb-3">
              <label for="contractId" class="form-label">Договор *</label>
              <select class="form-select" id="contractId" th:field="*{contractId}" required>
                <option value="">Выберите договор на рассмотрении</option>
                <!-- ИЗМЕНЕНИЕ: используем inactiveContracts вместо activeContracts -->
                <option th:each="contract : ${inactiveContracts}"
                        th:value="${contract.id}"
                        th:text="'Договор №' + ${contract.id} + ' - ' + ${contract.service.name} + ' (статус: на рассмотрении)'"></option>
              </select>
              <div class="form-text">
                Доступны только договоры со статусом "На рассмотрении".
                <span th:if="${inactiveContracts.isEmpty()}" class="text-danger">
                  У вас нет договоров на рассмотрении. <a href="/client/contracts/create">Создайте новый договор</a>.
                </span>
              </div>
              <div th:if="${#fields.hasErrors('contractId')}" class="text-danger">
                <small th:errors="*{contractId}"></small>
              </div>
            </div>

            <div class="mb-3">
              <label for="name" class="form-label">Название объекта *</label>
              <input type="text" class="form-control" id="name" th:field="*{name}"
                     placeholder="Например: Офис компании, Склад, Жилой дом и т.д." required>
              <div th:if="${#fields.hasErrors('name')}" class="text-danger">
                <small th:errors="*{name}"></small>
              </div>
            </div>

            <div class="mb-3">
              <label for="address" class="form-label">Адрес *</label>
              <div class="input-group">
                <input type="text" class="form-control" id="address" th:field="*{address}"
                       placeholder="Введите адрес или выберите на карте" required>
                <button type="button" class="btn btn-outline-secondary" onclick="searchAddress()">
                  Найти на карте
                </button>
              </div>
              <div th:if="${#fields.hasErrors('address')}" class="text-danger">
                <small th:errors="*{address}"></small>
              </div>
            </div>

            <div class="coordinates-display">
              <div class="row">
                <div class="col-md-6">
                  <strong>Широта:</strong> <span id="latitudeDisplay">Не указана</span>
                  <input type="hidden" id="latitude" th:field="*{latitude}">
                </div>
                <div class="col-md-6">
                  <strong>Долгота:</strong> <span id="longitudeDisplay">Не указана</span>
                  <input type="hidden" id="longitude" th:field="*{longitude}">
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Выберите местоположение на карте:</label>
              <div id="map"></div>
              <div class="form-text">Кликните на карте, чтобы установить метку местоположения</div>
            </div>

            <div class="mb-3">
              <label for="description" class="form-label">Описание объекта</label>
              <textarea class="form-control" id="description" th:field="*{description}"
                        rows="3" placeholder="Дополнительная информация об объекте (особенности доступа, контакты ответственных и т.д.)"></textarea>
              <div th:if="${#fields.hasErrors('description')}" class="text-danger">
                <small th:errors="*{description}"></small>
              </div>
            </div>

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary" th:disabled="${inactiveContracts.isEmpty()}">
                <i class="fas fa-save"></i> Создать объект
              </button>
              <a href="/client/objects" class="btn btn-secondary">Отмена</a>
            </div>

            <!-- Сообщение если нет доступных договоров -->
            <div th:if="${inactiveContracts.isEmpty()}" class="alert alert-info mt-3">
              <i class="fas fa-exclamation-triangle"></i>
              У вас нет договоров на рассмотрении.
              <a href="/client/contracts/create" class="alert-link">Создайте новый договор</a>, чтобы добавить объект охраны.
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  let map;
  let placemark;

  ymaps.ready(init);

  function init() {
    map = new ymaps.Map("map", {
      center: [55.76, 37.64],
      zoom: 10
    });

    map.events.add('click', function (e) {
      const coords = e.get('coords');
      setCoordinates(coords);
      getAddressByCoords(coords);
    });
  }

  function setCoordinates(coords) {
    document.getElementById('latitude').value = coords[0].toFixed(8);
    document.getElementById('longitude').value = coords[1].toFixed(8);
    document.getElementById('latitudeDisplay').textContent = coords[0].toFixed(6);
    document.getElementById('longitudeDisplay').textContent = coords[1].toFixed(6);

    if (placemark) {
      map.geoObjects.remove(placemark);
    }

    placemark = new ymaps.Placemark(coords, {
      balloonContent: 'Выбранное местоположение'
    }, {
      preset: 'islands#icon',
      iconColor: '#0095b6'
    });

    map.geoObjects.add(placemark);
    map.setCenter(coords, 15);
  }

  function getAddressByCoords(coords) {
    ymaps.geocode(coords).then(function (res) {
      const firstGeoObject = res.geoObjects.get(0);
      if (firstGeoObject) {
        document.getElementById('address').value = firstGeoObject.getAddressLine();
      }
    });
  }

  function searchAddress() {
    const address = document.getElementById('address').value.trim();
    if (!address) {
      alert('Пожалуйста, введите адрес для поиска');
      return;
    }

    ymaps.geocode(address).then(function (res) {
      const firstGeoObject = res.geoObjects.get(0);
      if (!firstGeoObject) {
        alert('Адрес не найден. Попробуйте уточнить запрос.');
        return;
      }

      const coords = firstGeoObject.geometry.getCoordinates();
      setCoordinates(coords);
      document.getElementById('address').value = firstGeoObject.getAddressLine();
    });
  }

  document.getElementById('objectForm').addEventListener('submit', function(e) {
    const latitude = document.getElementById('latitude').value;
    const longitude = document.getElementById('longitude').value;

    if (!latitude || !longitude) {
      e.preventDefault();
      alert('Пожалуйста, укажите местоположение объекта на карте');
      return false;
    }
  });
</script>
</body>
</html>